"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var axios=_interopDefault(require("axios")),qs=_interopDefault(require("qs"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,o)}return r}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)r=a[o],0<=t.indexOf(r)||(n[r]=e[r]);return n}function _objectWithoutProperties(e,t){if(null==e)return{};var r,o,n=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)r=a[o],0<=t.indexOf(r)||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var HttpError={default:"网络走神了,请稍后再试",repeat:"请求频率过快",cancel:"请求已取消",network:"网络异常或服务器连接失败",aborted:"请求被中止",timeout:"请求服务器响应超时，请求已经被中断",301:"请求的资源已被永久的移动到新URI",302:"请求的资源临时被移动，请重新发送请求",303:"请求的资源已被永久的移动到新URI，使用GET和POST请求查看",304:"所请求资源未变动，已使用本地缓存资源进行访问",305:"所请求的资源必须通过代理访问",306:"请求的资源已被移动",307:"请求的资源临时被移动，使用GET请求重定向",400:"客户端请求发生语法错误，服务器无法处理该请求",401:"被请求的页面需要进行身份验证",402:"未知客户端错误",403:"所请求页面的禁止访问",404:"Not Found，所请求地址不存在",405:"请求中指定的方法被禁止使用",406:"服务器无法根据客户端请求的内容特性完成请求",407:"用户必须首先使用代理服务器进行验证并授权",408:"服务器等待客户端发送的请求已超时",409:"由于冲突，请求无法被完成",410:"指定请求的页面已经被移动或不存在",411:"服务器无法处理客户端发送的不带 Content-Length 的请求信息",412:"请求失败，请求中前提条件有错误",413:"由于所请求的实体的太大，服务器拒绝处理该请求",414:"请求的URI过长（URI通常为网址），服务器无法处理",415:"服务器无法处理请求附带的媒体格式",416:"客户端请求的范围 Range 无效",417:"服务器无法满足 Expect 的请求头信息",500:"服务器内部错误，无法完成请求",501:"服务器不支持所请求的功能，无法完成请求",502:"充当网关或代理的服务器，从远端服务器接收到了一个无效的请求",503:"由于超载或系统维护，服务器暂时的无法处理客户端的请求",504:"充当网关或代理的服务器，未及时从远端服务器获取请求",505:"服务器不支持请求中指明的HTTP协议版本"};function formatError(e){return{message:e,name:1<arguments.length&&void 0!==arguments[1]?arguments[1]:"error",type:"error"}}HttpError.merge=function(e){Object.assign(HttpError,e)},HttpError.info=function(e){switch(_typeof(e)){case"undefined":return formatError(HttpError.network);case"object":if(e.response&&e.response.status&&HttpError[e.response.status])return formatError("[".concat(e.response.status,"] ").concat(HttpError[e.response.status]),"server");if(e instanceof Error)return/^timeout of/i.test(e.message)?formatError(HttpError.timeout,"timeout"):/^network/i.test(e.message)?formatError(HttpError.network,"network"):formatError(e.message);if(/^cancel/i.test(e.toString())){var t=e.message;return HttpError.hasOwnProperty(t)?formatError(HttpError[t],t):formatError(HttpError.cancel)}return formatError(HttpError.default);case"string":return formatError(e);default:return formatError(HttpError.default)}};var ResponseType={text:"text",json:"json",blob:"blob",document:"document",arraybuffer:"arraybuffer"},ContentType={stream:"application/octet-stream",json:"application/json",form:"application/x-www-form-urlencoded",formData:"multipart/form-data",javascript:"application/x-javascript"},Queue=function(){function f(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,f),this.options=e,this.list=[]}return _createClass(f,[{key:"cancel",value:function(e,t){if(e){var r=this.get(e);r&&this._cancel(r,t),r&&this.dequeue(r)}else for(var o=this.list,n=o.length-1;0<=n;n--){var a=o[n];this._cancel(a,t),this.dequeue(a)}}},{key:"_cancel",value:function(e,t){e&&("function"==typeof e.cancelToken&&e.cancelToken(t),e.cancelToken=null)}},{key:"get",value:function(t){return this.list.filter(function(e){return e.uuid===t.uuid})[0]}},{key:"enqueue",value:function(e,t){for(var r=this,o=this.options,n="boolean"==typeof e.stopRepeatRequest?e.stopRepeatRequest:o.stopRepeatRequest,a=[],s=this.list,i=s.length-1;0<=i;i--){var u=s[i];u.id===e.id&&n&&a.push(u)}s.push(e),a.forEach(function(e){r.cancel(e,t)})}},{key:"dequeue",value:function(e){var t=this.list;this.log("准备移除队列",JSON.stringify(this.list));for(var r=e.uuid,o=t.length-1;0<=o;o--){var n=t[o];if(n.uuid===r){this.log("移除队列成功",n.uuid),t.splice(o,1);break}}}},{key:"log",value:function(){this.options.debug&&console.log.apply(this,arguments)}},{key:"error",value:function(){this.options.debug&&console.error.apply(this,arguments)}},{key:"warn",value:function(){this.options.debug&&console.warn.apply(this,arguments)}}],[{key:"getQueueUniqueId",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},r=t.data,o=void 0===r?null:r,n=t.params,a=void 0===n?null:n,s=t.method,i=void 0===s?"":s,u=t.url,c=void 0===u?"":u,l=null,p="";return p="string"==typeof(l=["get","delete","head"].includes(i.toLowerCase())?a:o)?l:(c=f.replace(c,l||{}),qs.stringify(l)),"".concat(c,"?method=").concat(i,"&").concat(p)}},{key:"replace",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:{},o=t;try{Object.keys(r).forEach(function(e){t=t.replace(new RegExp("{".concat(e,"}"),"img"),r[e])}),o=t}catch(e){console.error(e)}return o}}]),f}(),CancelToken=axios.CancelToken;function guid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}var HTTP=function(){function g(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,g),_defineProperty(this,"_conf",null),_defineProperty(this,"_axios",null),_defineProperty(this,"_api",[]),_defineProperty(this,"isTrim",!0),_defineProperty(this,"stopRepeatRequest",!1),_defineProperty(this,"repeatInterval",2e3),_defineProperty(this,"debug",!1),_defineProperty(this,"HttpError",HttpError);var r=e.api,o=e.debug,n=e.isTrim,a=e.getResponseSuccess,s=e.stopRepeatRequest,i=e.repeatInterval,u=e.HttpError,c=e.beforeRequest,l=e.afterRequest,p=e.handleRequest,f=e.handleError,d=e.handleSuccess,h=e.setHeaders,y=e.getHeaders,v=_objectWithoutProperties(e,["api","debug","isTrim","getResponseSuccess","stopRepeatRequest","repeatInterval","HttpError","beforeRequest","afterRequest","handleRequest","handleError","handleSuccess","setHeaders","getHeaders"]),m={debug:o,isTrim:n,getResponseSuccess:a,stopRepeatRequest:s,repeatInterval:i,HttpError:u,beforeRequest:c,afterRequest:l,handleRequest:p,handleError:f,handleSuccess:d,setHeaders:h,getHeaders:y};Object.keys(m).forEach(function(e){void 0!==m[e]&&(t[e]=m[e])}),this._conf=Object.assign({},g.Default,v),this._api=this.formatAPI(r),this._init()}return _createClass(g,[{key:"_init",value:function(){var n=this,r=this.HttpError;this._axios=axios.create(this._conf),this._axios.interceptors.request.use(function(o){n.log("[interceptors.request.config]",o),n.handleRequest&&n.handleRequest(o);var e=n.setHeaders&&n.setHeaders(o),t=(o.data||o.params||{}).$timeout;return e&&(o.headers=Object.assign(o.headers,e||{})),t&&(o.timeout=t),o.uuid=guid(),o.cancelToken=new CancelToken(function(e){var t=Queue.getQueueUniqueId(o),r={stopRepeatRequest:o.stopRepeatRequest,uuid:o.uuid,id:t,cancelToken:e};n.log("enqueue",r),n._queue.enqueue(r,"repeat")}),o},function(e){n.error("interceptors.request.error",e.message,e),Promise.reject(e)}),this._axios.interceptors.response.use(function(e){var t=e.config.repeatInterval||n.repeatInterval;return setTimeout(function(){n._queue.dequeue(e.config)},t),n._responseHandler(e)},function(e){n.error("interceptors.response.error",e.message,e.config),e&&e.response&&n._queue.dequeue(e.response.config);var t=r.info(e);return Promise.reject(t)}),this._queue=new Queue({debug:this.debug,HttpError:r,stopRepeatRequest:this.stopRepeatRequest})}},{key:"toURL",value:function(t){return t&&Object.keys(t).length?"?"+Object.keys(t).map(function(e){return"".concat(e,"=").concat(encodeURIComponent(t[e]))}).join("&"):""}},{key:"replace",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:{};return Object.keys(r).forEach(function(e){t=t.replace(new RegExp("{".concat(e,"}"),"img"),r[e])}),t}},{key:"beforeRequest",value:function(){}},{key:"afterRequest",value:function(){}},{key:"handleRequest",value:function(){}},{key:"handleError",value:function(){}},{key:"handleSuccess",value:function(e){return Promise.resolve(e)}},{key:"getResponseSuccess",value:function(){return!0}},{key:"setHeaders",value:function(){}},{key:"getHeaders",value:function(){}},{key:"cancel",value:function(e){this.log("取消队列",this._queue.list.length),this._queue.cancel(null,e||"cancel")}},{key:"formatAPI",value:function(s){var i=[],u={};return Array.isArray(s)?s.forEach(function(e){var t=e.name,r=void 0===t?"":t,o=e.path,n=void 0===o?"":o,a=e.method,s={name:r,path:n,method:void 0===a?"get":a,meta:_objectSpread2({},_objectWithoutProperties(e,["name","path","method"]))};if(!s.name||!s.path)throw new Error("缺少name, path");if(u[s.name])throw new Error("存在相同的name");u[s.name]=1,i.push(s)}):"[object Object]"===Object.prototype.toString.call(s)&&Object.keys(s).forEach(function(e){var t=s[e],r="string"==typeof t?[t]:t,o=r[0],n=_objectSpread2({},r[1]),a={name:e,path:o,method:n.method||n.methods||"get",meta:_objectSpread2({},n)};if(!a.name||!a.path)throw new Error("缺少name, path");i.push(a)}),console.log("api",i),i}},{key:"toAPI",value:function(e){var t=this.formatAPI(e),i={},u=this;return t.forEach(function(e){var r=e.path,t=e.name,o=e.method,n=void 0===o?"get":o,a=e.meta,s=void 0===a?{}:a;i[t]=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=_objectSpread2({},s,{},1<arguments.length&&void 0!==arguments[1]?arguments[1]:{});return u[n](r,e,t)}}),i}},{key:"trimData",value:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&"string"==typeof e[t]&&(e[t]=e[t].replace(/^\s+|\s+$/gm,""));return e}},{key:"request",value:function(e){var o=this,t=0<arguments.length&&void 0!==e?e:{},r=this._api||[],n=this.isTrim,a=t.url,s=void 0===a?"":a,i=t.payload,u=void 0===i?null:i,c=t.method,l=void 0===c?"GET":c,p=t.params,f=void 0===p?null:p,d=t.data,h=void 0===d?null:d,y=_objectWithoutProperties(t,["url","payload","method","params","data"]),v=r.filter(function(e){return e.name===s})[0],m=v?v.path:s,g=v?Object.assign({},y,v.meta||{}):y,b=_objectSpread2({},g);return u=u||h||f||{},l=v?v.method||"GET":l,["GET","HEAD","DELETE"].includes(l.toUpperCase())?b.params=u:b.data=u,s=this.replace(m,u),n&&this.trimData(b.params),n&&this.trimData(b.data),b.url=s,b.method=l,this.log("request原装参数",JSON.stringify(t)),this.log("request最终参数",JSON.stringify(b)),new Promise(function(t,r){o.beforeRequest({url:s,path:m,payload:u,meta:g}),o._axios.request(b).then(function(e){o.afterRequest({url:s,path:m,payload:u,meta:g,body:e}),t(e)}).catch(function(e){o.afterRequest({url:s,path:m,payload:u,meta:g,body:e}),r(e)})}).then(function(e){return o.handleSuccess({body:e,path:m,url:s,payload:u,meta:g}),e}).catch(function(e){return"cancel"!==e.name&&o.handleError({body:e,path:m,url:s,payload:u,meta:g}),Promise.reject(e)})}},{key:"get",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:[],n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"GET",url:e,params:o},n))}},{key:"head",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:[],n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"HEAD",url:e,params:o},n))}},{key:"post",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:null,n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"POST",url:e,data:o},n))}},{key:"put",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:null,n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"PUT",url:e,data:o},n))}},{key:"patch",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:null,n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"PATCH",url:e,data:o},n))}},{key:"delete",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:null,n=2<arguments.length&&void 0!==r?r:{};return this.request(_objectSpread2({method:"DELETE",url:e,params:o},n))}},{key:"download",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:null,n=2<arguments.length&&void 0!==r?r:{};return n.responseType=ResponseType.arraybuffer,this.request(_objectSpread2({url:e,payload:o},n)).then(function(e){if(e.headers){var t=e.headers["x-suggested-filename"];if(!t){var r=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(e.headers["content-disposition"]);null!=r&&r[1]&&(t=r[1].replace(/['"]/g,""))}if(t){var o=window.URL.createObjectURL(new Blob([e.data])),n=document.createElement("a");return n.href=o,n.setAttribute("download",decodeURIComponent(t)),n.click(),window.URL.revokeObjectURL(o),{message:"下载成功"}}return Promise.reject({name:"download",message:"文件内容已损坏"})}return e})}},{key:"_responseHandler",value:function(e){if(this.getHeaders&&this.getHeaders(e),"blob"===e.config.responseType)return Promise.resolve(e);if("arraybuffer"===e.config.responseType){if(!(-1<((e.headers||{})["content-type"]||"").indexOf("application/json")))return Promise.resolve(e);try{var t=JSON.parse(Buffer.from(e.data).toString("utf8"));return this.getResponseSuccess(t)?Promise.resolve(t):Promise.reject(t)}catch(e){return Promise.reject(e)}}return this.getResponseSuccess(e.data)?Promise.resolve(e.data):Promise.reject(e.data)}},{key:"batchUseInterceptor",value:function(e){var n=this;e.forEach(function(e){var t=e.type,r=e.interceptor,o=e.error;n.useInterceptor(t,r,o)})}},{key:"useInterceptor",value:function(e,t,r){var o=2<arguments.length&&void 0!==r?r:null;return this._axios.interceptors[e].use(t,o)}},{key:"ejectInterceptor",value:function(e,t){var r=this._axios.interceptors[e],o=r.handlers;t instanceof Number&&t<o.length?r.eject(t):o.forEach(function(e,t){r.eject(t)})}},{key:"log",value:function(){this.debug&&console.log.apply(this,arguments)}},{key:"error",value:function(){this.debug&&console.error.apply(this,arguments)}},{key:"warn",value:function(){this.debug&&console.warn.apply(this,arguments)}}]),g}();function install(e,t){e.http=new HTTP(t)}_defineProperty(HTTP,"Default",{baseURL:"",timeout:15e3,responseType:ResponseType.json,withCredentials:!1,headers:{"Content-Type":ContentType.json},paramsSerializer:function(e){return qs.stringify(e,{arrayFormat:"repeat"})}}),exports.install=install,exports.Request=HTTP,exports.HttpError=HttpError,exports.ResponseType=ResponseType,exports.ContentType=ContentType;
//# sourceMappingURL=index.js.map
